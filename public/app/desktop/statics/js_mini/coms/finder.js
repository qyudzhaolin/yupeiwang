!function(){this.finderGroup={},this.finderDestory=function(){for(var a in finderGroup)delete finderGroup[a]};var a=function(a,b,c){b=b||"controller";var d={},e={};return e[b]=e[b]||{},e[b][c[0]]=c[1],d[a]=e,d},b=new Class({Extends:Drag,start:function(a){this.parent(a)}});Finder=new Class({Implements:[Events],options:{selectName:"items[]"},detailStatus:{},initialize:function(a,b){$extend(this.options,b),this.id=a,this.initStaticView(),this.initView(),this.listContainer=this.list.getContainer(),this.attachStaticEvents(),this.attachEvents(),this.options.packet&&this.loadPacket()},initStaticView:function(){$each(["action","form","filter","search","tip","header","footer","pager","packet"],function(a){this[a]=$("finder-"+a+"-"+this.id)},this)},initView:function(){this.list=$("finder-list-"+this.id),this.list&&this.list.store("visibility",!0),this.tip=$("finder-tip-"+this.id)},isVisibile:function(){return this.list.retrieve?$chk(this.list.retrieve("visibility")):!1},attachStaticEvents:function(){var a=this;if(a.search){var b=a.search.getElement("input[search]").addEvent("keypress",function(b){if(13===b.code){b.stop(),this.value.trim().length||(a.filter.value="");var c=a.form.retrieve("rowselected",[]);a.refresh(c.length&&!c.contains("_ALL_")&&!confirm(LANG_Finder.refresh_confirm))}});a.search.getElement(".finder-search-btn").addEvent("click",function(){b.fireEvent("keypress",{stop:$empty,code:13})})}if(a.action&&a.action.getElements("*[submit]").addEvent("click",function(b){b&&b.stop&&b.stop();var c=this.get("target"),d=this.get("submit"),e=a.form.retrieve("rowselected",[]),f=a.form.retrieve("_rowindex",$H());!e.length&&f&&f.getValues().sort(function(a,b){return a.toInt()-b.toInt()}).each(function(a){e.push(f.keyOf(a))});var g=new Element("form"),h=document.createDocumentFragment(),i=!1;if(e.each(function(b){var c=a.options.selectName;"_ALL_"==b&&(i=c="isSelectedAll"),h.appendChild(new Element("input",{type:"hidden",name:c,value:b}))}),g.appendChild(h),!g.getFirst())return MessageBox.error(LANG_Finder.error);var j=c,k={};c&&c.contains("::")&&(j=c.split("::")[0],k=JSON.decode(c.split("::")[1]),"object"!=$type(k)&&(k={}));var l=this.getProperty("confirm");if(!l||window.confirm(l)){if(i){var m=a.form.action.match(/\?([\s\S]+$)/);m=m[1]?m[1]:"";var n=[m,a.form.toQueryString(),a.filter.value].join("&");g.adopt(n.toFormElements())}switch(j){case"refresh":W.page(d,$extend({data:g,method:"post",onComplete:a.refresh.bind(a)},k));break;case"command":new cmdrunner(actionurl,{onSuccess:a.refresh.bind(a)});break;case"dialog":new Dialog(d,$extend({title:this.get("dialogtitle")||this.get("text"),ajaxoptions:{data:g,method:"post"},onClose:function(){a.unselectAll(),a.refresh.call(a)}},k));break;case"_blank":var o=g.set({action:d,name:j,target:"_blank",method:"post"}).inject(document.body);o.submit(),o.remove.delay(1e3,o);break;default:W.page(d,$extend({data:g,method:"post"},k))}}}),a.header){a.header.addEvent("click",function(b){var c=$(b.target);if(c.hasClass("orderable")||(c=c.getParent(".orderable")),c){var d=["desc"==c.get("order")?"asc":"desc",c.get("key")].link({"_finder[orderType]":String.type,"_finder[orderBy]":String.type});a.fillForm(d).refresh(),b.stopPropagation()}});var c=function(b,c){try{a.header.setStyles({width:a.listContainer.clientWidth-a.listContainer.getPatch().x})}catch(d){}};c(),LAYOUT.content_main.addEvent("resizelayout",c),a.header.addEvent("dispose",function(){LAYOUT.content_main.removeEvent("resizelayout",c)})}},selectAll:function(a){this.header.getElement(".sellist")&&this.header.getElement(".sellist").set("checked",!a).fireEvent("change"),a?(this.form.retrieve("_rowindex",$H()).empty(),this.tip.fireEvent("_hide")):(this.form.retrieve("rowselected").empty().push("_ALL_"),this.tip.fireEvent("_update","selectedall").fireEvent("_show"))},unselectAll:function(){this.selectAll(!0)},selectFav:function(a){this.form.retrieve("rowselected").empty(),this.form.retrieve("_rowindex",$H()).empty(),this.list.getElements(".row .sel").each(function(b){b.hasClass("isfav")?b.set("checked",!a).fireEvent("change"):b.set("checked",!!a).fireEvent("change")})},selectunFav:function(){this.selectFav(!0)},attachEvents:function(){var c=this,d=this.listContainer,f=(c.list.retrieve("eventInfo",{}),c.form.retrieve("rowselected",[]));if(c.header&&c.list.getElement("tr")){var g=c.header.getElement(".finder-header"),h=g.getElements(".finder-col-resizer"),i=g.getElements("col"),j=g.getElement("tr").getChildren(),k=c.list.getElements("col");new b(g,{modifiers:{x:!1,y:!1},limit:{x:[35,1e3]},handle:Array.from(h),onStart:function(a,b){a.addClass("col-resizing");var e;e=b.target.getParent(".cell")?b.target.getParent(".cell").getParent("td"):b.target.getParent("td")?b.target.getParent("td"):b.target;var f=j.indexOf(e);if(0>f)return this.cancel();var g=j[f].getElement(".finder-col-resizer");a.store("_dragTargetIndex",f),i[f].addClass("resizing").setStyle("background","#e9e9e9");var h=a.retrieve("_dragTargetMoveEl");h||(h=new Element("div",{"class":"resize-move-el",styles:{height:c.header.offsetHeight+d.offsetHeight,width:g.offsetWidth,position:"absolute",top:g.getPosition().y,left:g.getPosition().x,background:"#e9e9e9",zIndex:65535,cursor:"col-resize",opacity:.8,borderRight:"1px #cccccc solid"}}).inject(document.body),a.store("_dragTargetMoveEl",h))},onDrag:function(a){a.retrieve("_dragTargetMoveEl",{}).setStyle("left",this.mouse.now.x)},onComplete:function(b){b.removeClass("col-resizing");var e=b.retrieve("_dragTargetIndex"),f=i[e].removeClass("resizing").setStyle("background","");if(b.retrieve("_dragTargetMoveEl")){b.retrieve("_dragTargetMoveEl").dispose(),b.eliminate("_dragTargetMoveEl");var g=this.mouse.now.x-this.mouse.start.x,h=f.getStyle("width").toInt(),l=(h+g).limit(this.options.limit.x[0],this.options.limit.x[1]),m=$$(f,k[e]),n=c.list.getElement("tr").getChildren()[e];window.webkit&&(m=$$(m,j[e],n)),m.setStyle("width",l);var o=d.scrollLeft,p=d.offsetWidth,q=d.scrollWidth;if(o>0&&o+p>=q){var r=l-h;0>r&&(d.scrollLeft=(d.scrollLeft-Math.abs(r)).limit(0,d.scrollWidth))}if(c.dropmenu&&c.dropmenu.fireEvent("position","x"),n){var s=n.get("key");EventsRemote.post({events:a("finder_colset",c.options.object_name+"_"+c.options.finder_aliasname,[s,l])})}}}})}if(c.tip){c.tip.addEvents({_update:function(a,b){this.retrieve("arg:class","NULL")!=a&&$$(this.childNodes).hide();var c=this.getElement("."+a);if(c&&(c.innerHTML=c.innerHTML.replace(/<em>([\s\S]*?)<\/em>/gi,function(){return"<em>"+b+"</em>"}),c.setStyle("display","block")),this.store("arg:class",a),!this.retrieve("tipclone")){var e=new Element("div",{"class":"hide",html:"&nbsp;",styles:{height:this.offsetHeight}}).injectTop(d);this.store("tipclone",e)}},_show:function(){"hidden"==this.style.visibility&&(this.setStyle("visibility","visible"),this.retrieve("tipclone").removeClass("hide"))},_hide:function(){"hidden"!=this.style.visibility&&(this.setStyle("visibility","hidden"),this.retrieve("tipclone").addClass("hide"))}});var l=f.length;l>1&&(l==c.tip.get("count").toInt()||f.contains("_ALL_")?c.tip.fireEvent("_update",["selectedall",l]).fireEvent("_show"):c.tip.fireEvent("_update",["selected",l]).fireEvent("_show"))}c.list.addEvents({selectrow:function(a){a.getParent(".row").addClass("selected")},unselectrow:function(a){a.getParent(".row").removeClass("selected")}});var m=c.list.getElements(".row .sel");if(c.rowCount=m.length,c.header&&c.header.getElement(".sellist"))var n=c.header.getElement(".sellist").addEvent("change",function(){m.set("checked",this.checked).fireEvent("change")});m.addEvents({click:function(){this.fireEvent("change")},focus:function(){this.blur()},change:function(){if(n){f[this.checked?"include":"erase"](this.value);var a=c.form.retrieve("_rowindex",$H());this.checked?a.set(this.value,this.get("rowindex")):a.erase(this.value)}else f.empty().push(this.value);if(!this.checked&&f.contains("_ALL_"))return f.erase("_ALL_"),c.unselectAll();console.log(f);var b=f.length,d=0;b>0?b==c.tip.get("count").toInt()||f.contains("_ALL_")?c.tip.fireEvent("_update",["selectedall",b]).fireEvent("_show"):(c.tip.fireEvent("_update",["selected",b]),d=function(){return $clear(d),f.length<2?void 0:"mousedown"==c.list.retrieve("eventState")?d=arguments.callee.delay(200):void c.tip.fireEvent("_show")}.delay(200)):($clear(d),c.tip.fireEvent("_update",["selected"]).fireEvent("_hide")),c.list.fireEvent(this.checked?"selectrow":"unselectrow",this)}}),m.filter(function(a){return f&&f.push&&(f.contains(a.value)||f.contains("_ALL_"))}).set("checked",!0).fireEvent("change");var o=c.list.getElement("tr[item-id="+c.detailStatus.rowId+"]");o&&c.showDetail(o.getElement("span[detail]").get("detail"),{},o),c.list.addEvent("click",function(b){var d=$(b.target);if(d){if(d.match("img")&&(d=$(d.parentNode)),d.hasClass("fav-star")){d.toggleClass("fav-star-on");var e=d.getParent("tr[item-id]");return e.getElement(".sel").toggleClass("isfav"),EventsRemote.post({events:a("finder_favstar",c.options.object_name+"_"+c.options.finder_aliasname,["id-"+e.get("item-id"),d.hasClass("fav-star-on")?1:0])})}var f=d.get("detail");if(f)return b.stopPropagation(),c.showDetail(f,{},d.getParent(".row"));if((d.hasClass("cell")||d.hasClass("cell-inside"))&&(d=d.getParent("td")),d.match("td")){if(!/row/.test(d.parentNode.className))return;if(c.detailStatus.row){var g=d.getParent(".row").getElement("*[detail]");if(g&&!d.getParent(".row").hasClass("view-detail"))return c.showDetail(g.get("detail"),{},d.getParent(".row"))}}}}),attachEsayCheck(c.list,"td:nth-child(first) .span-auto");var p=0,q=function(){$clear(p),p=function(){if(this.listContainer.scrollLeft!=this.header.scrollLeft){var a=this.header.scrollLeft=this.listContainer.scrollLeft,b=this.listContainer.getElement(".finder-detail-content");b&&b.setStyle("margin-left",a)}this.tip&&"none"!=this.tip.style.visibility&&this.tip.setStyles({left:this.listContainer.scrollLeft,top:this.listContainer.scrollTop})}.delay(200,this)}.bind(this);q(),this.listContainer.addEvent("scroll",q),this.list.addEvent("dispose",function(){this.listContainer.removeEvent("scroll",q)}.bind(this)),this.cellOpts.call(this)},fillForm:function(a){if(a&&"object"==$type(a)){a=$H(a);var b=this;return a.each(function(a,c){var d=b.form.getElement("input[name^="+c.slice(0,-1)+"]")||new Element("input",{type:"hidden",name:c}).inject(b.form);d.set("value",a)}),b}},eraseSelected:function(){var a=this,b=a.form.retrieve("rowselected",[]);if("_ALL_"!=b[0]){var c=a.list.getElements(".row .sel");$splat(arguments).flatten().each(function(d){var e=c.filter(function(a){return a.value==d});e.length?e.set("checked",!1).fireEvent("change"):(b.erase(d),a.tip.fireEvent("_update",["selected",b.length]))})}},eraseFormElement:function(){var a=Array.flatten(arguments),b=this;return $each(a,function(a){b.form.getElement("input[name="+a+"]").remove()}),b},scrollTab:function(a,b,c){b||(b=LAYOUT.content_main),c||(c=a);var d=a.getElements("li"),e=a.getElements(".scroll-handle"),f=a.getElement(".tabs-items"),g=2;d.each(function(a){g+=a.offsetWidth+a.getPatch("margin").x}),a.getElement("ul").setStyle("width",g);var h=new Fx.Scroll(f,{link:"cancel"}),i=function(){try{var c=b.offsetWidth;a[g>c?"addClass":"removeClass"]("tabs-scroll").setStyle("width",c-2),f.setStyle("width",c-2*f.getStyle("marginLeft").toInt()),h.options.duration=500,h.scrollIntoView(a.getElement(".current"))}catch(d){}};i(),LAYOUT.content_main.addEvent("resizelayout",i),c.addEvent("dispose",function(){LAYOUT.content_main.removeEvent("resizelayout",i)}),e.addEvents({mouseenter:function(){h.options.duration=850,h[this.hasClass("r")?"toRight":"toLeft"]()},mouseleave:function(){h.stop()}})},showDetail:function(a,b,c){var d=this,e=c.getNext(),f=c.get("item-id");if(this.detailCurTab&&this.detailCurTab[0]==f&&(a=this.detailCurTab[1]),e&&e.hasClass("finder-detail"))return this.hideDetail(c,e);this.hideDetail(this.detailStatus.row,this.detailStatus.dp);var g=new Element("tr",{"class":"finder-detail"}),h=new Element("td",{colspan:c.getElements("td").length,"class":"finder-detail-colspan"}),i=new Element("div",{"class":"finder-detail-content clearfix",id:"finder-detail-"+this.id}).set({container:!0});g.adopt(h.adopt(i));var j=this.list.getContainer(),k=this.detailStatus.Request;k&&k.cancel(),this.detailStatus.row=c.addClass("view-detail"),this.detailStatus.rowId=f,this.detailStatus.Request=new Request.HTML({evalScripts:!1,url:a+(a.indexOf("&")>0?"&":"")+"finder_name="+this.id,onRequest:function(){new MessageBox(LANG_Finder.detail.request,{type:"notice"})},onComplete:function(a,b,e,f){g.injectAfter(c),new MessageBox(LANG_Finder.detail.complete,{autohide:1}),W.render(i.set("html",e));var k=function(){try{i.setStyle("width",j.clientWidth-h.getPatch().x)}catch(a){}};k(),LAYOUT.content_main.addEvent("resizelayout",k),d.list.addEvent("dispose",function(){LAYOUT.content_main.removeEvent("resizelayout",k)});var l=i.getElement(".finder-tabs-wrap");l&&i.getParent(".finder-detail-colspan").addEvent("click",function(a){var b=$(a.target);"A"==b.tagName&&b.getParent(".finder-tabs-wrap")&&(a.stop(),W.page(b.href,{update:i,onComplete:function(){d.scrollTab(i.getElement(".finder-tabs-wrap"),i,d.list)}}))}),l&&d.scrollTab(l,i,d.list),$globalEval(f)}.bind(this),onFailure:function(){new MessageBox(LANG_Finder.detail.failure+[this.xhr.status],{type:"error",autohide:!0})}}).send().chain(function(){delete this.detailStatus.Request,this.detailStatus.dp=g}.bind(this))},hideDetail:function(a,b){a&&a.removeClass("view-detail"),b&&b.remove(),delete this.detailCurTab,delete this.detail,delete this.detailStatus.row,delete this.detailStatus.dp,delete this.detailStatus.rowId},getFormQueryString:function(){return this.form.toQueryString()},page:function(a){this.form.store("page",a||1),this.request({method:this.form.method||"post"})},loadPacket:function(){var a=this.packet,b=this;this.options.packet&&new Request.HTML({url:this.form.action+"&action=packet",update:a,onRequest:function(){a.addClass("loading")},onComplete:function(){a.removeClass("loading"),b.scrollTab(a)}}).get()},storeTab:function(){var a=$("finder-detail-"+this.id);if(a){var b=a.getElement(".finder-tabs-wrap .current");b&&(this.detailCurTab=[b.get("item-id"),b.get("url")])}},refresh:function(a){this.storeTab(),this.request({method:this.form.method||"post",onComplete:function(){this.loadPacket(),a&&this.unselectAll()}.bind(this)})},filter2packet:function(){var a=this.filter.value;a&&new Dialog(this.form.action+"&action=filter2packet",{width:400,height:200,ajaxoptions:{method:"post",data:{filterquery:a,finder_id:this.id}}})},setCount:function(){var a=this.tip.get("count").toInt(),b=$E(".finder-title .count");return b&&b.setText(a),this},request:function(){var a=Array.flatten(arguments),b=a.link({options:Object.type,action:String.type});b.action=b.action||this.form.action+"&page="+(this.form.retrieve("page")||1),b.options=b.options||{};var c=b.options.onComplete;"function"!=$type(c)&&(c=$empty),$extend(b.options,{clearUpdateMap:!1,updateMap:{".innerheader":this.header,".pager":this.pager},onComplete:function(){this.initView(),this.setCount().attachEvents(),c.apply(this,Array.flatten(arguments));var a=$("filter-tip-"+this.id);a&&(this.filter.value.trim().length?a.setStyle("visibility","visible").highlight("#FFFFCC"):a.setStyle("visibility","hidden"))}.bind(this)}),this.search&&this.search.getElement("input[search]").value.trim().length&&(this.filter.value=this.search.toQueryString());var d=this.getFormQueryString().concat("&"+this.filter.value),e=b.options.data;switch($type(e)){case"string":b.options.data=[d,e].join("&");break;case"object":case"hash":b.options.data=[d,Hash.toQueryString(e)].join("&");break;case"element":b.options.data=[d,$(e).toQueryString()].join("&");break;default:b.options.data=d}for(v in this.detailStatus)"element"==$type(this.detailStatus[v])&&delete this.detailStatus[v];W.page(b.action,b.options)},cellOpts:function(){var a=this,b=a.list.getElements(".opt-handle");b&&b.each(function(b,c){a.dropmenu=new DropMenu(b,{eventType:"mouse",stopState:!0,relative:$("main"),offset:{x:0,y:0},delay:0,size:!0,onPosition:function(a){if("x"==a){var c=b.getSize().x,d=b.getParent("td"),e=d.getSize().x,f=d.getPatch().x,g=c>e?e-f-b.getParent(".cell").getStyle("padding-right").toInt():c;this.options.offset.x=g-this.menu.getStyle("border-left-width").toInt()}},onHide:function(){this.element.style.position=""},onInitShow:function(){a.detailStatus.rowId&&(this.status=!0)},onShow:function(b){this.element.style.position="relative",this.bind||(b.getElements("a").addEvent("click",function(b){var c=this.get("submit")||this.get("url"),d=this.get("target");if(d&&c){b.preventDefault();var e=d.split("::")[0]||d,f=JSON.decode(d.split("::")[1])||{};switch(e){case"dialog":var g=new Dialog(c,$extend(f,{onLoad:function(){this.dialog.getElement("form").store("target",{onComplete:function(b){return g.close(),b?void a.refresh():MessageBox.error("REFRESH ERROR!")}})}}));break;case"tab":a.showDetail(c,f,this.getParent("tr"));break;case"request":new Request({url:c,method:"post",data:f.data,onComplete:function(b){a.showDetail(f.url,{},this.getParent("tr"))}.bind(this)}).send();break;case"confirm":var h=this.get("confirm");if(h&&!confirm(h))return;W.page(c,{onComplete:function(b){a.refresh()}})}}}),this.bind=!0)}})})}}),Filter=new Class({Implements:[Events,Options],options:{onPush:$empty,onRemove:$empty,onChange:$empty},initialize:function(a,b,c){var d=this;d.finderId=b,d.filter=$(a),d.finderObj=window.finderGroup[b],this.setOptions(c)},update:function(){var a=this.filter,b=a.toQueryString(function(b){var d,c=$(b).getParent("dl");if(c&&c.isDisplay()&&$(b).value&&(!(d=b.name.match(/_([\s\S]+)_search/))||a.getElement("*[name="+d[1]+"]").value)&&(!b.name.match(/_DTYPE_TIME/)||a.getElement("*[name="+b.value+"]").value)&&(!(d=b.name.match(/_DTIME_\[([^\]]+)\]\[([^\]]+)\]/))||a.getElement("*[name="+d[2]+"]").value))return!0},!0);this.finderObj.search&&(this.finderObj.search.getElement("input[search]").value=""),this.finderObj.filter.value=b;var c=this.finderObj.form.retrieve("rowselected",[]);!c.length||c.contains("_ALL_")||confirm(LANG_Finder.refresh_confirm)?this.finderObj.refresh():(this.finderObj.form.eliminate("rowselected"),this.finderObj.refresh(!0)),this.fireEvent("change")},retrieve:function(){var a=this.finderObj.filter.value||"";this.finderObj.search&&(this.finderObj.search.getElement("input[search]").value="");var b=this;a.replace(/([^&]+)\=([^&]+)/g,function(){var a=arguments,c=a[1],d=b.filter.getElement("[name="+c+"]");c&&c.slice(-1)&&"]"==c.slice(-1)&&(d=b.filter.getElement("[name^="+c.substr(0,c.length-1)+"]")),d&&(d.value=decodeURIComponent(a[2]))})}})}(),function(){var a=new Tips({onShow:function(a,b){b.addClass("active");var c;a.setStyle("display","block").store("tip:imgsource",c=$pick(b.get("href"),b.get("src")));var d=a.getElement(".tip-text").set("html","&nbsp;").addClass("loading");Asset.image(c,{onload:function(){this.src==a.retrieve("tip:imgsource")&&(d.empty().adopt(this.zoomImg(d.offsetWidth,d.offsetHeight)).removeClass("loading"),this.setStyle("margin-top",(d.offsetHeight-this.height)/2))}})},text:function(a){return"&nbsp;"},className:"finder-col-img-tip"}),b=new Tips({onShow:function(a,b){b.addClass("active"),a.setStyle("display","block");var c=b.retrieve("loaded:html"),d=a.getElement(".tip-text");return c?d.set("html",c):(d.set("html","&nbsp;").addClass("loading"),void new Request({url:b.get("data-load"),onSuccess:function(a){d.removeClass("loading").empty().set("html",a),b.store("loaded:html",a)}}).get())},text:function(a){return"&nbsp;"},className:"finder-col-desc-tip"}),c=new Tips({onShow:function(a,b){b.addClass("active"),a.setStyle("display","block")},text:function(a){return a.get("title")||a.get("rel")},className:"finder-col-text-tip"}),d=new Tips({onShow:function(a,b){b.addClass("active"),a.setStyle("display","block")},text:function(a){return a.getElement("textarea").value},className:"finder-col-desc-tip"});this.bindFinderColTip=function(e){e=new Event(e);var f=e.target;f&&(f.onmouseover=null,f.hasClass("img-tip")?a.attach(f):f.hasClass("desc-tip")?d.attach(f):f.hasClass("load-tip")?b.attach(f):c.attach(f),f.addEvent("mouseleave",function(){this.removeClass("active")}),f.fireEvent("mouseenter",e))}}();