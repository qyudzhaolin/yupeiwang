var DatePickers=new Class({Implements:[Events,Options],options:{onShow:function(a){Browser.ie6&&$$("select").setStyle("visibility","hidden");a.setStyle("visibility","visible")},onHide:function(a){Browser.ie6&&$$("select").setStyle("visibility","visible");a.setStyles({visibility:"hidden",left:"",top:""})},type:"datepicker",shortest:12,hasNight:!0,showDelay:100,hideDelay:100,className:"datepicker",offsets:{x:0,y:0},dateformat:"-",days:LANG_formplus.days,months:LANG_formplus.months,year:LANG_formplus.year,
weekFirstDay:1},initialize:function(a,c){this.setOptions(c||{});this.lock=!1;this.build();(a||a.length)&&$$(a).each(function(a){a.retrieve("bindDatePicker")||(a.store("bindDatePicker",!0),this.attach(a))},this)},build:function(){var a=this.options.className;"datetable"===this.options.type&&(a+=".datetable",this.datetable={});this.datepicker=(new Element("div."+a)).addEvents({mouseover:function(){this.lock=!0}.bind(this),mouseout:function(){this.lock=!1}.bind(this)});this.container=new Element("div."+
this.options.className+"-content");this.table=new Element("table[cellpadding=0][cellspacing=0]");this.table.inject(this.container.inject(this.datepicker))},attach:function(a){var c=a.retrieve("datepicker:dateformat",a.get("accept")),b,d=new Date;c||(c=this.options.dateformat,a.store("datepicker:dateformat",c));"datepicker"===this.options.type?(b=a.retrieve("datepicker:datevalue",a.value),b||(b=this.format(d,c),a.store("datepicker:datevalue",b))):(b=this.format(d,c),a.store("datepicker:datevalue",
b),this.curHour=d.getHours(),this.curDay=d.getDay());a.store("datepicker:current",this.unformat(b,c));c=a.retrieve("datepicker:focus",this.elementFocus);b=a.retrieve("datepicker:blur",this.elementBlur);a.addEvents({focus:c.bind(this,a),blur:b.bind(this)});a.store("datepicker:native",a.get("accept"));a.erase("dateformat");return this},detach:function(a){$$(a).each(function(a){a.removeEvent("onfocus",a.retrieve("datepicker:focus")||function(){});a.removeEvent("onblur",a.retrieve("datepicker:blur")||
function(){});a.eliminate("datepicker:focus").eliminate("datepicker:blur");var b=a.retrieve("datepicker:native");b&&a.set("dateformat",b)});return this},elementFocus:function(a){this.datepicker.retrieve("injected")||(this.datepicker.inject(document.id(this.options.inject)||document.body),this.datepicker.store("injected",!0));this.el=a;var c=a.retrieve("datepicker:current");this.curFullYear=c[0];this.curMonth=c[1];this.curDate=c[2];this.refresh();this.timer=clearTimeout(this.timer);this.timer=this.show.delay(this.options.showDelay,
this);this.position(a)},elementChange:function(){if("datepicker"===this.options.type)this.el.store("datepicker:current",[this.curFullYear,this.curMonth,this.curDate]),this.el.value=this.format(new Date(this.curFullYear,this.curMonth,this.curDate),this.el.retrieve("datepicker:dateformat"));else{if(this.el.get("real")){var a=new Date;if(new Date(this.curFullYear,this.curMonth,this.curDate)<new Date(a.getFullYear(),a.getMonth(),a.getDate()))return alert(LANG_formplus.dateerror)}this.el.value=this.format(new Date(this.curFullYear,
this.curMonth,this.curDate),this.el.retrieve("datepicker:dateformat"))+" "+this.datetable.periods[this.datetable.curPeriod]}clearTimeout(this.timer);this.timer=this.hide.delay(this.options.hideDelay,this)},elementBlur:function(a){this.lock||(clearTimeout(this.timer),this.timer=this.hide.delay(this.options.hideDelay,this))},position:function(a){this.datepicker.position({target:a,from:"lt",to:"lb",offset:this.options.offsets,scrollIntoView:!0})},show:function(){this.fireEvent("show",this.datepicker)},
hide:function(){this.fireEvent("hide",this.datepicker)},refresh:function(){"datepicker"===this.options.type?(this.table.empty(),this.caption().inject(this.table),this.thead().inject(this.table),this.tbody().inject(this.table)):this.table.getFirst()||(this.thead().inject(this.table),this.tbody().inject(this.table))},navigate:function(a,c){switch(a){case "m":var b=this.curMonth+c;0>b||12==b?(this.curMonth=0>b?11:0,this.navigate("y",c)):this.curMonth=b;break;case "y":this.curFullYear+=c}this.el.store("datepicker:current",
[this.curFullYear,this.curMonth,this.curDate]);this.el.focus()},caption:function(a){a=a||{prev:{month:!0,year:!0},next:{month:!0,year:!0},supper_prev:{month:!0,year:!0},supper_next:{month:!0,year:!0}};var c=new Element("caption"),b=new Element("a.prev",{html:"&lsaquo;"}),d=new Element("a.next",{html:"&rsaquo;"}),e=(new Element("span.year")).inject(c),f=new Element("a.supper_prev",{html:"&lsaquo;&lsaquo;"}),g=new Element("a.supper_next",{html:"&rsaquo;&rsaquo;"});a.supper_prev.year&&f.clone().addEvent("click",function(){this.navigate("y",-10)}.bind(this)).inject(e);a.prev.year&&b.clone().addEvent("click",function(){this.navigate("y",-1)}.bind(this)).inject(e);(new Element("span.name",{html:this.curFullYear+this.options.year,events:{mousewheel:function(a){a.stop();this.navigate("y",
0>a.wheel?-1:1);this.refresh()}.bind(this)}})).inject(e);a.next.year&&d.clone().addEvent("click",function(){this.navigate("y",1)}.bind(this)).inject(e);a.supper_next.year&&g.clone().addEvent("click",function(){this.navigate("y",10)}.bind(this)).inject(e);e=(new Element("span.month")).inject(c);a.prev.month&&b.clone().addEvent("click",function(){this.navigate("m",-1)}.bind(this)).inject(e);(new Element("span.name",{html:this.options.months[this.curMonth],events:{mousewheel:function(a){a.stop();this.navigate("m",0>a.wheel?-1:1);this.refresh()}.bind(this)}})).inject(e);a.next.month&&d.clone().addEvent("click",
function(){this.navigate("m",1)}.bind(this)).inject(e);return c},thead:function(){var a=["<tr>"];if("datepicker"===this.options.type)for(i=0;7>i;i++)a.push("<th>"+this.options.days[(this.options.weekFirstDay+i)%7].substr(0,3)+"</th>");else{a.push('<th class="period">时间段</th>');console.log(this.curMonth);var c=this.curMonth+1,b=this.curDate,d=this.curDay,e=(new Date(this.curFullYear,c,0)).getDate(),g;this.datetable.weekMonth=[];this.datetable.weekDay=[];for(i=0;7>i;i++)g=b+i,g>e&&(g-=e),1===g&&g!==
b&&(c+=1),a.push("<th>"+c+this.options.dateformat+g+"<br>"+(0===i?"今天":"周"+this.options.days[(d+i)%7]+"</th>")),this.datetable.weekMonth[i]=c-1,this.datetable.weekDay[i]=g}a.push("</tr>");a.join("");return new Element("thead",{html:a})},tbody:function(){var a,c,b;if("datepicker"===this.options.type){b=new Date(this.curFullYear,this.curMonth,1);var d=(b.getDay()-this.options.weekFirstDay+7)%7,e=(new Date(this.curFullYear,this.curMonth+1,0)).getDate(),g=(new Date(this.curFullYear,this.curMonth,0)).getDate();
b=this.el.value?this.unformat(this.el.value,this.el.retrieve("datepicker:dateformat")):!1;var n=(new Date(b[0],b[1],b[2])).getTime();b=new Date;var l=(new Date(b.getFullYear(),b.getMonth(),b.getDate())).getTime();a=new Element("tbody",{events:{mousewheel:function(a){a.stop();this.navigate("m",0>a.wheel?-1:1);this.refresh()}.bind(this)}});for(var h=1;43>h;h++){0==(h-1)%7&&(c=new Element("tr"));b=new Element("td");var f=h-d,k=new Date(this.curFullYear,this.curMonth,f);1>f?(f=g+f,b.addClass("inactive")):
f>e?(f-=e,b.addClass("inactive")):(b.addClass("active").addEvents({click:function(a){this.curDate=a;this.elementChange()}.bind(this,f),mouseenter:function(a){Browser.ie6&&a.addClass("current")}.bind(this,b),mouseleave:function(a,b){b.getTime()!=n&&Browser.ie6&&a.removeClass("current")}.bind(this,b,k)}),k.getTime()==n?b.addClass("current"):k.getTime()==l&&b.addClass("today"));b.set("text",f).inject(c.inject(a))}}else{a=new Element("tbody");b=this.options.hasNight;d=Math.floor(this.options.shortest);
e=this.curHour;l=[8,12];this.datetable.periods=["08:00-12:00","12:00-18:00"];b?(l.push(18),this.datetable.periods.push("18:00-22:00"),k=21):k=14;for(var m,h=1;h<k+1;h++){b=new Element("td");f=(h-1)%7;m=Math.floor((h-1)/7);0==f&&(g=e+d,c=(new Element("tr")).set("html","<td>"+this.datetable.periods[m]+"</td>"));var p=this.datetable.weekMonth[f],f=this.datetable.weekDay[f];g>l[m]?b.addClass("inactive"):(b.addClass("active").set("text","可选").addEvent("click",function(b,c,d,e){this.curMonth=c;this.curDate=
d;this.datetable.curPeriod=e;this.elementChange();a.getElements(".current").removeClass("current").set("text","可选");b.addClass("current").set("text","已选")}.bind(this,b,p,f,m)),Browser.ie6&&b.addEvents({mouseenter:function(a){this.addClass("current")},mouseleave:function(a){this.removeClass("current")}}));g-=24;b.inject(c.inject(a))}}return a},unformat:function(a,c){var b=a.split(c),d=[3];if(3>b.length||!b[0]||!b[1]||!b[2])return[(new Date).getFullYear(),(new Date).getMonth(),(new Date).getDate()];
d[0]=b[0].toInt();d[1]=b[1].toInt()-1;d[2]=b[2].toInt();return d},format:function(a,c){if(a){var b=a.getDate();a.getDay();var d=a.getMonth()+1;return[a.getFullYear()+"",d,b].join(c)}return""}});Element.implement({makeCalable:function(a){if(!this.retrieve("bindDatePicker"))return new DatePickers(this,a)}});
